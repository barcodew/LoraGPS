<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Live GPS</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
      html,
      body,
      #map {
        height: 100%;
        margin: 0;
      }
      .panel {
        position: absolute;
        z-index: 1000;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 8px 12px;
        border-radius: 8px;
        font-family: system-ui, Segoe UI, Roboto, Arial;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div class="panel">
      <div><b>Lat:</b> <span id="lat">-</span></div>
      <div><b>Lon:</b> <span id="lon">-</span></div>
      <div>
        <b>Sats:</b> <span id="sats">-</span> &nbsp; <b>HDOP:</b>
        <span id="hdop">-</span>
      </div>
      <div><b>Updated:</b> <span id="ts">-</span></div>
    </div>

    <script>
      // Elemen UI
      const el = {
        lat: document.getElementById("lat"),
        lon: document.getElementById("lon"),
        sats: document.getElementById("sats"),
        hdop: document.getElementById("hdop"),
        ts: document.getElementById("ts"),
      };

      // Peta
      const map = L.map("map").setView([-5.354, 119.452], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap",
      }).addTo(map);
      const marker = L.marker([-5.354, 119.452]).addTo(map);

      // Selalu ikuti lokasi terbaru
      function render(d) {
        if (typeof d.lat !== "number" || typeof d.lon !== "number") return;
        const latlng = [d.lat, d.lon];
        marker.setLatLng(latlng);
        map.panTo(latlng); // ← auto-follow (halus)
        el.lat.textContent = d.lat.toFixed(6);
        el.lon.textContent = d.lon.toFixed(6);
        el.sats.textContent = d.sats ?? "-";
        el.hdop.textContent = d.hdop ?? "-";
        el.ts.textContent = d.ts ? new Date(d.ts).toLocaleString() : "-";
      }

      // Ambil snapshot awal
      fetch("/latest", { cache: "no-store" })
        .then((r) => r.json())
        .then(render);

      // SSE + auto-reconnect; tanpa reload halaman
      let es;
      let retryMs = 1000;
      let pollId = null;

      function startPolling() {
        if (pollId) return;
        pollId = setInterval(async () => {
          try {
            const d = await (
              await fetch("/latest", { cache: "no-store" })
            ).json();
            render(d);
          } catch {}
        }, 1000); // ← polling 1 detik (fallback)
      }
      function stopPolling() {
        if (pollId) {
          clearInterval(pollId);
          pollId = null;
        }
      }

      function connectSSE() {
        if (es) es.close();
        es = new EventSource("/events");
        es.onopen = () => {
          stopPolling();
          retryMs = 1000;
        };
        es.onmessage = (e) => {
          render(JSON.parse(e.data));
        };
        es.onerror = () => {
          startPolling();
          setTimeout(connectSSE, retryMs);
          retryMs = Math.min(retryMs * 2, 30000);
        };
      }
      connectSSE();
    </script>
  </body>
</html>
