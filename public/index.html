<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GPS Multi-Sender</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>

    <style>
      html,
      body,
      #root {
        height: 100%;
        margin: 0;
        font-family: Inter, system-ui, Arial;
      }
      .app {
        position: relative;
        height: 100%;
      }

      /* ===== Sidebar (off-canvas untuk semua ukuran) ===== */
      .sidebar-panel {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 88vw;
        max-width: 360px;
        background: #fff;
        border-right: 1px solid #eee;
        overflow: auto;
        transform: translate3d(-100%, 0, 0);
        transition: transform 0.25s ease;
        z-index: 1200;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
        padding: 12px;
        will-change: transform;
      }
      body.drawer-open .sidebar-panel {
        transform: translate3d(0, 0, 0);
      }

      .backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
        z-index: 1100;
      }
      body.drawer-open .backdrop {
        opacity: 1;
        pointer-events: auto;
      }

      /* ===== Map container ===== */
      .map {
        position: relative;
        height: 100%;
        transition: padding-left 0.25s ease;
      }
      #map {
        position: absolute;
        inset: 0;
      }

      /* Desktop: saat drawer terbuka, geser map ke kanan 360px */
      @media (min-width: 1024px) {
        body.drawer-open .map {
          padding-left: 360px;
        }
      }

      .card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 10px;
        margin-bottom: 10px;
        background: #fff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
        cursor: pointer;
        transition: transform 0.05s ease;
      }
      .card:hover {
        transform: translateY(-1px);
      }
      .card.active {
        outline: 2px solid #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.12);
      }
      .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .muted {
        color: #6b7280;
        font-size: 12px;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border: none;
        border-radius: 10px;
        background: #111827;
        color: #fff;
        cursor: pointer;
      }
      .btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }
      .search {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
      }
      .title {
        font-weight: 600;
      }

      /* Marker styles via divIcon */
      .marker {
        width: 14px;
        height: 14px;
        background: #10b981;
        border: 2px solid white;
        border-radius: 999px;
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.15);
      }
      .marker.dim {
        background: #a7f3d0;
        box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1);
      }

      /* Focus pulse ring */
      .pulse {
        position: absolute;
        width: 18px;
        height: 18px;
        border-radius: 999px;
        border: 2px solid #ef4444;
        box-shadow: 0 0 0 rgba(239, 68, 68, 0.4);
        animation: pulse 1.6s infinite;
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
        }
        70% {
          box-shadow: 0 0 0 12px rgba(239, 68, 68, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
        }
      }

      /* Floating hamburger — selalu di atas Leaflet controls & sidebar */
      .toggle {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 2147483647;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 8px 10px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.12);
      }
      .toggle svg {
        width: 18px;
        height: 18px;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script>
      const { useEffect, useRef, useState, useMemo } = React;

      function App() {
        const [devices, setDevices] = useState(new Map());
        const [focusId, setFocusId] = useState(null);
        const [filter, setFilter] = useState("");
        const [open, setOpen] = useState(
          () => window.matchMedia("(min-width: 1024px)").matches
        );
        const mapRef = useRef(null);
        const markersRef = useRef(new Map());
        const focusLayerRef = useRef(null);
        const sidebarRef = useRef(null);

        const isDesktop = () =>
          window.matchMedia("(min-width: 1024px)").matches;

        // Sinkronkan state -> <body class="drawer-open">
        useEffect(() => {
          document.body.classList.toggle("drawer-open", open);
        }, [open]);

        // Invalidasi map setelah animasi panel selesai ATAU saat padding-left map berubah
        useEffect(() => {
          const el = sidebarRef.current;
          const map = mapRef.current;
          if (!el || !map) return;
          const onEnd = () => map.invalidateSize();
          el.addEventListener("transitionend", onEnd);
          return () => el.removeEventListener("transitionend", onEnd);
        }, []);

        // init map
        useEffect(() => {
          const map = L.map("map", { zoomControl: true }).setView(
            [-3.55, 118.9],
            6
          );
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "&copy; OpenStreetMap",
          }).addTo(map);
          mapRef.current = map;
          return () => map.remove();
        }, []);

        // SSE subscribe
        useEffect(() => {
          const es = new EventSource("/events");
          es.addEventListener("snapshot", (e) => {
            const arr = JSON.parse(e.data);
            setDevices(new Map(arr.map((d) => [d.id, d])));
          });
          es.addEventListener("update", (e) => {
            const d = JSON.parse(e.data);
            setDevices((prev) => {
              const n = new Map(prev);
              n.set(d.id, d);
              return n;
            });
          });
          return () => es.close();
        }, []);

        // keep markers in sync
        useEffect(() => {
          const map = mapRef.current;
          if (!map) return;

          devices.forEach((v, id) => {
            let m = markersRef.current.get(id);
            const focused = id === focusId;
            const icon = L.divIcon({
              html: `<div class="marker ${focused ? "" : "dim"}"></div>`,
              iconSize: [14, 14],
              iconAnchor: [7, 7],
            });
            if (!m) {
              m = L.marker([v.lat, v.lon], { icon }).addTo(map).bindTooltip(id);
              markersRef.current.set(id, m);
            } else {
              m.setLatLng([v.lat, v.lon]);
              m.setIcon(icon);
            }
          });

          markersRef.current.forEach((m, id) => {
            if (!devices.has(id)) {
              map.removeLayer(m);
              markersRef.current.delete(id);
            }
          });

          if (focusLayerRef.current) {
            map.removeLayer(focusLayerRef.current);
            focusLayerRef.current = null;
          }
          if (focusId && devices.has(focusId)) {
            const v = devices.get(focusId);
            const icon = L.divIcon({
              html: '<div class="pulse"></div>',
              iconSize: [18, 18],
              iconAnchor: [9, 9],
            });
            focusLayerRef.current = L.marker([v.lat, v.lon], {
              icon,
              interactive: false,
            }).addTo(map);
          }
        }, [devices, focusId]);

        const list = useMemo(() => {
          const arr = Array.from(devices, ([id, v]) => ({ id, ...v }));
          arr.sort((a, b) => a.id.localeCompare(b.id));
          if (!filter) return arr;
          const f = filter.toLowerCase();
          return arr.filter((d) => d.id.toLowerCase().includes(f));
        }, [devices, filter]);

        function centerOnFocus() {
          if (!focusId || !devices.has(focusId)) return;
          const v = devices.get(focusId);
          mapRef.current.setView(
            [v.lat, v.lon],
            Math.max(15, mapRef.current.getZoom())
          );
          if (!isDesktop()) setOpen(false);
        }

        return React.createElement(
          "div",
          { className: "app" },
          React.createElement("div", {
            className: "backdrop",
            onClick: () => setOpen(false),
          }),
          React.createElement(
            "aside",
            { className: "sidebar-panel", ref: sidebarRef },
            React.createElement(
              "div",
              { className: "header" },
              React.createElement("div", { className: "title" }, "Devices"),
              React.createElement(
                "button",
                {
                  className: "btn",
                  onClick: centerOnFocus,
                  disabled: !focusId,
                },
                "Center on focus"
              )
            ),
            React.createElement("input", {
              className: "search",
              placeholder: "Cari ID…",
              value: filter,
              onChange: (e) => setFilter(e.target.value),
            }),
            (() => {
              const items = Array.from(devices, ([id, v]) => ({ id, ...v }))
                .sort((a, b) => a.id.localeCompare(b.id))
                .filter((d) =>
                  d.id.toLowerCase().includes(filter.toLowerCase())
                );
              return items.length === 0
                ? React.createElement(
                    "div",
                    { className: "muted", style: { marginTop: 16 } },
                    "Belum ada data perangkat"
                  )
                : items.map((d) =>
                    React.createElement(
                      "div",
                      {
                        key: d.id,
                        className: "card " + (focusId === d.id ? "active" : ""),
                        onClick: () => {
                          setFocusId(d.id);
                        },
                      },
                      React.createElement(
                        "div",
                        { className: "row" },
                        React.createElement(
                          "div",
                          null,
                          React.createElement("div", null, d.id),
                          React.createElement(
                            "div",
                            { className: "muted" },
                            `LAT ${d.lat.toFixed(6)} | LON ${d.lon.toFixed(6)}`
                          )
                        ),
                        React.createElement(
                          "div",
                          { className: "muted" },
                          `SATS ${d.sats ?? 0} • HDOP ${d.hdop ?? 0}`
                        )
                      ),
                      React.createElement(
                        "div",
                        { className: "muted" },
                        `Updated: ${new Date(d.ts).toLocaleTimeString()}`
                      )
                    )
                  );
            })()
          ),
          React.createElement(
            "div",
            { className: "map" },
            React.createElement(
              "button",
              {
                className: "toggle",
                onClick: () => {
                  document.activeElement?.blur();
                  /* ios focus quirk */ setOpen((v) => !v);
                },
                "aria-label": open ? "Tutup sidebar" : "Buka sidebar",
                "aria-pressed": open,
              },
              open
                ? React.createElement(
                    "svg",
                    {
                      viewBox: "0 0 24 24",
                      fill: "none",
                      stroke: "currentColor",
                      "stroke-width": "2",
                      "stroke-linecap": "round",
                      "stroke-linejoin": "round",
                    },
                    React.createElement("line", {
                      x1: "18",
                      y1: "6",
                      x2: "6",
                      y2: "18",
                    }),
                    React.createElement("line", {
                      x1: "6",
                      y1: "6",
                      x2: "18",
                      y2: "18",
                    })
                  )
                : React.createElement(
                    "svg",
                    {
                      viewBox: "0 0 24 24",
                      fill: "none",
                      stroke: "currentColor",
                      "stroke-width": "2",
                      "stroke-linecap": "round",
                      "stroke-linejoin": "round",
                    },
                    React.createElement("line", {
                      x1: "3",
                      y1: "6",
                      x2: "21",
                      y2: "6",
                    }),
                    React.createElement("line", {
                      x1: "3",
                      y1: "12",
                      x2: "21",
                      y2: "12",
                    }),
                    React.createElement("line", {
                      x1: "3",
                      y1: "18",
                      x2: "21",
                      y2: "18",
                    })
                  )
            ),
            React.createElement("div", { id: "map" })
          )
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(
        React.createElement(App)
      );
    </script>
  </body>
</html>
